<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/general.css">
    <link rel="stylesheet" href="./css/homeStyles.css">
    <title>File Uploader</title>
</head>
<body>
    <h1>File Uploader</h1>
    <%- include('nav', {url : currentUrl}) %>
    <div class="header">
      <h1 class="title">Home</h1>
      <% if (locals.currentUser) { %>
        <h2>Welcome, <%= locals.currentUser.username %></h2>
      <% } %>
    </div>

    <div class="fileCabinet">
      <% for(let i = 0; i < folders.length; i++) { %>
        <div class="folder">
          <div class="leftContent">
            <button class="folderButton">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#434343"><path d="M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h240l80 80h320q33 0 56.5 23.5T880-640v400q0 33-23.5 56.5T800-160H160Zm0-80h640v-400H447l-80-80H160v480Zm0 0v-480 480Z"/></svg>
            </button>
            <form class="folderNameForm" data-folder-id="<%= folders[i].id %>">
              <input type="text" name="folderName" value="<%= folders[i].foldername %>" class="folderName">
            </form>
          </div>
          <div class="centerContent">

          </div>
          <div class="rightContent">
            <button class="deleteFolderButton svgButton" data-folder-id="<%= folders[i].id %>">
              <svg class="deletesvg" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#434343"><path d="m376-300 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56Zm-96 180q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520Zm-400 0v520-520Z"/></svg>
            </button>
            <div class="confirmDelete" style="display: none;">
              <p>Are you sure?</p>
              <button class="confirmYes" data-folder-id="<%= folders[i].id %>">Yes</button>
              <button class="confirmCancel">Cancel</button>
            </div>
          </div> 
          </div>
      <% } %>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.deleteFolderButton').forEach(button => {
          button.addEventListener('click', (event) => {
            const folderId = button.getAttribute('data-folder-id');
            const confirmDelete = button.nextElementSibling;
            button.style.display = 'none';
            confirmDelete.style.display = 'block';
          });
        });

        document.querySelectorAll('.confirmCancel').forEach(button => {
          button.addEventListener('click', (event) => {
            const confirmDelete = button.parentElement;
            const deleteButton = confirmDelete.previousElementSibling;
            confirmDelete.style.display = 'none';
            deleteButton.style.display = 'block';
          });
        });

        document.querySelectorAll('.confirmYes').forEach(button => {
          button.addEventListener('click', async (event) => {
            console.log('confirm delete fires on click');
            const folderId = button.getAttribute('data-folder-id');
            try {
              const response = await fetch(`/delete-folder/${folderId}`, {
                method: 'DELETE',
              });
              console.log('response:', response);

              if (!response.ok) {
                throw new Error('Failed to delete folder');
              }

              const result = await response.json();
              console.log('Folder deleted:', result);

              // Remove the folder from the DOM
              const folderElement = button.closest('.folder');
              folderElement.remove();
            } catch (error) {
              console.error('Error deleting folder:', error);
            }
          });
        });
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.folderNameForm').forEach(form => {
        form.addEventListener('submit', async (event) => {
          console.log('Form submitted');
          event.preventDefault();
          const folderId = form.getAttribute('data-folder-id');
          const folderName = form.folderName.value;
    
          try {
            console.log('Updating folder name:', folderName);
            const response = await fetch(`/update-folder/${folderId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ folderName }),
            });
    
            if (!response.ok) {
              throw new Error('Failed to update folder name');
            }
    
            const result = await response.json();
            console.log('Folder updated:', result);

            // Update the DOM with the new folder name
            form.folderName.value = result.foldername;
          } catch (error) {
            console.error('Error updating folder name:', error);
          }
        });
      });
    });
    </script>

    <button class="createFolderButton svgButton"><svg class="createFolder svg" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#434343"><path d="M560-320h80v-80h80v-80h-80v-80h-80v80h-80v80h80v80ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h240l80 80h320q33 0 56.5 23.5T880-640v400q0 33-23.5 56.5T800-160H160Zm0-80h640v-400H447l-80-80H160v480Zm0 0v-480 480Z"/></svg></button>
    <div class="insertedFolderForm"></div>
    <script>
      let open = false;
      const createFolderButton = document.querySelector('.createFolderButton');
      const htmlLocation = document.querySelector('.insertedFolderForm');
      const folderCreationHtml = `<%- folderCreationHtml %>`;
      createFolderButton.addEventListener('click', () => {
        if(!open){
        htmlLocation.innerHTML = folderCreationHtml
        open = true;
        }
        else{
          htmlLocation.innerHTML = ``;
          open = false;
        }
      });
    </script>
    
    
  
    <form action="/fileupload" enctype="multipart/form-data" method="post">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="File Name" name="fileName">
          <input type="file" class="form-control-file" name="uploaded_file">
          <input type="submit" value="Save File" class="btn btn-default">
        </div>
      </form>
</body>
</html>